name: 'Tomcat Deploy'

on:
  push:
    branches: [ deploy ]

jobs:
  Tomcat_Deploy:
    runs-on: self-hosted
    
    steps:
    - uses: actions/checkout@v2

    - name: Copy application.properties
      run: mv src/main/resources/application.properties src/main/resources/application.properties.bak

    - name: git submodule pull 
      run: git submodule update --init --recursive
      
    - name: Copy submodules
      run: cp -r src/main/ecpay/ecpay src/main/java/ 

    - name: replace host url
      run: sed -i 's/http:\/\/localhost:8080/https:\/\/iiiedug02.nilm.in/g' src/main/java/net/ddns/iiiedug02/controller/TradeController.java

    - name: replace log file path
      run: sed -i 's/\${DEV_LOG_FILE_PATH}/\${DEPLOY_LOG_FILE_PATH}/g' src/main/resources/log4j2.xml

    - name: Remove context-path
      run: sed -e "/server.servlet.context-path=\/*/d" src/main/resources/application.properties.bak > src/main/resources/application.properties
          
    - name: Build war file
      run: mvn package
            
    - name: Remove old file
      run: echo ${{ secrets.PASSWORD }} | sudo -S rm -rf /var/lib/tomcat9/webapps/SpecialTopic*
      
    - name: Move new file
      run: echo ${{ secrets.PASSWORD }} | sudo -S cp target/SpcialTopic.war /var/lib/tomcat9/webapps/SpecialTopic.war
